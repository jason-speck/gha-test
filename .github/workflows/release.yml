name: Create Release
on:
  workflow_run:
    workflows: ["EXE builder"]
    types:
      - completed
    branches:
      - jason/fake-main
  workflow_dispatch:

permissions:
  contents: write  # Needed for creating releases

jobs:
  create_draft:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
        
      - name: Download all artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: pyinstaller_test.yml
          workflow_conclusion: success
          run_id: ${{ github.event.workflow_run.id }}
          
      - name: Get version from artifacts
        id: version
        run: |
          # Extract version from any artifact name
          VERSION=$(ls hello-*-* | head -n1 | cut -d- -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
      - name: Prepare files for release
        run: |
          # Create a directory for renamed files
          mkdir release-files
          
          # Copy and rename files with platform suffix
          cp hello-*-linux/hello* release-files/hello-linux 2>/dev/null || true
          cp hello-*-windows/hello* release-files/hello-windows.exe 2>/dev/null || true
          cp hello-*-macos/hello* release-files/hello-macos 2>/dev/null || true
          cp hello-*-macos/install.sh release-files/install.sh 2>/dev/null || true
          
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }} (Pending Review)
          draft: true  # Creates as draft for manual review
          files: |
            release-files/*
          body: |
            ## ⚠️ This release is pending review
            
            ### Review Checklist:
            - [ ] Binaries have been tested
            - [ ] Version numbers are correct
            
            To approve: Edit this release and click "Publish release"
            To reject: Delete this draft release
